{% extends 'base.html' %}

{% block title %} Quick Quote {% endblock title %}

{% block content %}
<div class="bradcam_area bradcam_bg_2 mt-5">
    <div class="container">
        <div class="row">
            <div class="col-xl-12">
                <div class="bradcam_text text-center">
                    <h3>{{ product.name }} | Request a Quick Quote</h3>
                    <p><a href="{% url 'petrosa_app:index' %}">Home</a> / {{ product.product_name }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-5">
    <h2 class="text-center">Request a Quick Quote</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <form method="POST">
        {% csrf_token %}

        <div class="row">
            <div class="col-md-6">
                <label>Product Name</label>
                <input type="text" class="form-control" value="{{ product.name }}" readonly>
            </div>
            <div class="col-md-6">
                <label>First Name</label>
                {{ form.first_name }}
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label>Last Name</label>
                {{ form.last_name }}
            </div>
            <div class="col-md-6">
                <label>Email</label>
                {{ form.email }}
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label>Company Name</label>
                {{ form.company }}
            </div>
            <div class="col-md-6">
                <label>Phone</label>
                {{ form.phone }}
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label>City</label>
                {{ form.city }}
            </div>
            <div class="col-md-6">
                <label>Country</label>
                {{ form.country }}
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <label>State</label>
                <select id="state" name="state" class="form-control">
                    <option value="">Select State</option>
                </select>
            </div>
        </div>

        <div class="mt-3">
            <label>Message</label>
            {{ form.message }}
        </div>

        <div class="text-center mt-4 mb-4">
            <button type="submit" class="btn btn-primary">Submit Quote Request</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById('country').addEventListener('change', function() {
            let country = this.value.trim(); // Get selected country
            let stateSelect = document.getElementById('state');
            stateSelect.innerHTML = '<option value="">Loading...</option>'; // Show loading
            
            console.log("Selected Country:", country); // Debugging
    
            if (country) {
                let requestData = { country: country };
                console.log("Request Payload:", requestData); // Log request payload
    
                fetch("https://countriesnow.space/api/v0.1/countries/states", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log("API Response:", data); // Log response
    
                    stateSelect.innerHTML = '<option value="">Select State</option>'; // Reset dropdown
    
                    if (data.data && data.data.states && data.data.states.length > 0) {
                        data.data.states.forEach(state => {
                            let option = document.createElement("option");
                            option.value = state.name;
                            option.textContent = state.name;
                            stateSelect.appendChild(option);
                        });
                    } else {
                        stateSelect.innerHTML = '<option value="">No states found</option>';
                        console.warn("No states returned for:", country);
                    }
                })
                .catch(error => {
                    console.error("Error fetching states:", error);
                    stateSelect.innerHTML = '<option value="">Error loading states</option>';
                });
            } else {
                stateSelect.innerHTML = '<option value="">Select State</option>';
            }
        });
    });
    
  </script>

{% endblock %}
